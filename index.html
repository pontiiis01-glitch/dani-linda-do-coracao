<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finan√ßas Dani">

    <title>Finan√ßas da Dani üíñ</title>

    <link rel="icon" type="image/png" sizes="32x32" href="icone.png?v=99">
    <link rel="icon" type="image/png" sizes="16x16" href="icone.png?v=99">
    <link rel="shortcut icon" href="icone.png?v=99">
    <link rel="apple-touch-icon" href="icone.png?v=99">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ... (resto do CSS igual ao anterior) ... */
        :root {
            --primary: #db2777; /* Rosa Pink */
            --primary-dark: #be185d; 
            --bg-body: #fff1f2; 
            --bg-card: #ffffff;
            --text-main: #0f172a; 
            --text-muted: #64748b; 
            --border: #fecdd3;
            
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            
            --inter: #ff7a00; /* Laranja Inter */
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; }
        
        /* TELA DE SENHA */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
        }
        .lock-box {
            background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(219, 39, 119, 0.15); 
            text-align: center; max-width: 90%; width: 320px; border: 1px solid var(--border);
        }
        .lock-input {
            width: 100%; padding: 15px; font-size: 1.5rem; text-align: center; letter-spacing: 5px;
            border: 2px solid var(--border); border-radius: 10px; margin: 20px 0; outline: none;
            font-weight: 800; background: #fff; color: var(--primary);
        }
        .lock-input:focus { border-color: var(--primary); }
        .btn-unlock {
            background: var(--primary); color: white; border: none; padding: 15px; width: 100%;
            border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-unlock:hover { background: var(--primary-dark); }
        .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 10px; min-height: 20px; font-weight: 600; }

        /* APP CONTENT */
        #appContent { display: none; padding: 15px; padding-bottom: 100px; max-width: 1000px; margin: 0 auto; }
        
        /* HEADER */
        header { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; margin-top: 10px; }
        .controls-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
        
        .date-control {
            background: #fff; padding: 8px 15px; border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center;
            gap: 10px; border: 1px solid var(--border);
        }
        input[type="month"] { border: none; font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 600; background: transparent; cursor: pointer; color: var(--primary-dark); }
        input[type="month"]:focus { outline: none; }
        
        .btn-copy {
            background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 50px;
            font-size: 0.85rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px;
        }
        .btn-logout-simple {
            background: #fee2e2; color: #b91c1c; border: none; padding: 8px 12px; border-radius: 50px;
            font-size: 0.8rem; cursor: pointer; font-weight: 600;
        }

        .sync-indicator { font-size: 0.75rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: #fff; color: var(--text-muted); }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card-stat {
            background: var(--bg-card); padding: 15px; border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); border: 1px solid var(--border);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card-stat h3 { margin: 0 0 5px 0; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
        .card-stat .val { font-size: 1.3rem; font-weight: 800; color: var(--text-main); }
        .stat-input { width: 100%; font-size: 1.3rem; font-weight: 800; border: none; border-bottom: 2px dashed #fecdd3; background: transparent; padding: 0; color: inherit; }
        .stat-input:focus { outline: none; border-bottom-color: var(--primary); }

        /* CHART */
        .chart-container { background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--border); height: 300px; display: flex; justify-content: center; }

        /* CORES */
        .c-salary .val, .c-salary input { color: var(--success); }
        .c-total .val { color: var(--danger); }
        .c-rest .val { color: var(--primary); }
        .c-mine .val { color: var(--warning); }
        .c-emerg .val, .c-emerg input { color: #9333ea; }

        /* SE√á√ïES & TABELAS */
        .section { background: var(--bg-card); border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); margin-bottom: 30px; border: 1px solid var(--border); overflow: hidden; }
        .sec-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sec-header h2 { margin: 0; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .sec-body { padding: 20px; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 10px; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        input.td-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; background: #fff1f2; color: var(--text-main); }
        input.td-input:focus { background: #fff; border-color: var(--primary); outline: none; }
        select.icon-select { border: none; background: transparent; font-size: 1.2rem; cursor: pointer; }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
        
        .prog-bar { height: 4px; background: #fecdd3; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .prog-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        
        .btn-add { width: 100%; padding: 12px; margin-top: 15px; border-radius: 10px; border: 2px dashed #fda4af; background: #fff1f2; color: var(--primary); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-add:hover { background: #ffe4e6; }
        .btn-del { border: none; background: transparent; color: var(--danger); font-size: 1.2rem; cursor: pointer; }

        /* DEVEDORES */
        .debt-summary { display: flex; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; }
        .ds-box { flex: 1; text-align: center; }
        .ds-lbl { font-size: 0.7rem; text-transform: uppercase; color: #64748b; font-weight: 600; }
        .ds-val { font-size: 1.1rem; font-weight: 800; }
        .debt-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .debt-item { background: #fff; border: 1px solid var(--border); padding: 15px; border-radius: 12px; position: relative; }
        .debt-item.is-paid { background: #dcfce7; border-color: #86efac; opacity: 0.8; }
        .d-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .d-name { font-weight: 700; color: var(--primary-dark); font-size: 1rem; text-transform: capitalize; }
        .d-val { font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin: 5px 0; }
        .debt-item.is-paid .d-val { color: #15803d; text-decoration: line-through; }
        .d-status { font-size: 0.75rem; font-weight: 600; color: #b45309; background: #fffbeb; padding: 2px 8px; border-radius: 10px; }
        .debt-item.is-paid .d-status { color: #15803d; background: #fff; }
        .pay-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #fff; }
        .pay-check.checked { background: #22c55e; border-color: #22c55e; color: #fff; }

        footer { text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 40px; }

        /* ESTILOS CART√ïES */
        .style-inter { border-left: 5px solid var(--inter); } .style-inter h2 { color: var(--inter); }
        
        .bill-input { width: 100px; text-align: right; font-weight: bold; padding: 5px; border-radius: 5px; border: 1px solid #fecdd3; color: var(--primary-dark); }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="lock-box">
        <div style="font-size:3rem; margin-bottom:10px;">üíñ</div>
        <h2>Ol√°, Dani!</h2>
        <p style="color:#64748b; font-size:0.9rem;">Digite sua senha para organizar</p>
        
        <input type="password" id="passInput" class="lock-input" placeholder="****" inputmode="numeric">
        <div id="passError" class="error-msg"></div>
        
        <button class="btn-unlock" onclick="checkPassword()">ACESSAR PLANILHA</button>
    </div>
</div>

<div id="appContent">
    <header>
        <div class="controls-row">
            <div class="date-control">
                <span>üìÖ</span>
                <input type="month" id="monthPicker" onchange="changeMonth()">
            </div>
            <button class="btn-copy" onclick="copyPreviousMonth()">
                <span>üîÑ</span> Copiar M√™s Anterior
            </button>
            <button class="btn-logout-simple" onclick="lockApp()">Bloquear</button>
        </div>
        <div id="syncStatus" class="sync-indicator">Conectando...</div>
    </header>

    <div class="dashboard-grid">
        <div class="card-stat c-salary"><h3>Sal√°rio</h3><input type="number" id="salary" class="stat-input" value="0" oninput="calculateAll()"></div>
        <div class="card-stat c-emerg"><h3>üö® Reserva</h3><input type="number" id="emergencyFund" class="stat-input" value="0" oninput="calculateAll()"></div>
        <div class="card-stat c-total"><h3>Total Sa√≠das</h3><div class="val" id="totalExpenses">R$ 0,00</div></div>
        <div class="card-stat c-rest"><h3>Livre para Gastar</h3><div class="val" id="remaining">R$ 0,00</div></div>
        <div class="card-stat c-mine"><h3>Meu Custo Real</h3><div class="val" id="myRealExpenses">R$ 0,00</div></div>
    </div>

    <div class="chart-container">
        <canvas id="expenseChart"></canvas>
    </div>

    <div class="section">
        <div class="sec-header"><h2>üìâ Gastos Fixos & D√≠vidas</h2></div>
        <div class="sec-body">
            <div class="table-wrap"><table id="mainTable"><thead><tr><th style="width:40px">√çcone</th><th>Item</th><th style="width:100px">Valor</th><th style="width:40px; text-align:center">Meu?</th><th style="width:30px"></th></tr></thead><tbody></tbody></table></div>
            <button class="btn-add" onclick="addMainRow()">+ Adicionar Gasto Fixo</button>
        </div>
    </div>

    <div class="section style-inter">
        <div class="sec-header"><h2>üí≥ Meu Cart√£o Inter</h2><div><small>FATURA:</small><input type="number" id="interTotalBill" class="bill-input" oninput="calculateAll()"></div></div>
        <div class="sec-body">
            <div class="table-wrap"><table id="interTable"><thead><tr><th>Quem</th><th>Desc.</th><th>Parc.</th><th>Valor</th><th></th></tr></thead><tbody></tbody></table></div>
            <button class="btn-add" onclick="addSplitRow('interTable')">+ Adicionar no Inter</button>
            <div style="text-align:right; margin-top:10px; color:var(--inter)">Minha parte: <strong id="interMyShareDisplay">R$ 0,00</strong></div>
        </div>
    </div>

    <div class="section" style="border-left: 5px solid #10b981;">
        <div class="sec-header"><h2 style="color:#059669">üí∞ A Receber</h2></div>
        <div class="sec-body">
            <div class="debt-summary">
                <div class="ds-box"><div class="ds-lbl">A Receber</div><div class="ds-val" id="totalToReceive" style="color:#ef4444">R$ 0,00</div></div>
                <div class="ds-box" style="border-left:1px solid #e2e8f0"><div class="ds-lbl">J√° Recebido</div><div class="ds-val" id="totalReceived" style="color:#22c55e">R$ 0,00</div></div>
            </div>
            <div id="debtorsList" class="debt-list"></div>
        </div>
    </div>

    <footer>Controle Financeiro da Daniela üíñ</footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDBcLEJw2PiFoBvocr3Zq01sRjjakteHfs",
        authDomain: "app-controle-gastos-1e658.firebaseapp.com",
        projectId: "app-controle-gastos-1e658",
        storageBucket: "app-controle-gastos-1e658.firebasestorage.app",
        messagingSenderId: "738629744462",
        appId: "1:738629744462:web:f299e491bafe5a059cd01f",
        measurementId: "G-02QPMRE4M8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const SENHA_DO_SISTEMA = "0805"; 

    window.checkPassword = function() {
        const input = document.getElementById('passInput').value;
        const errorDiv = document.getElementById('passError');
        
        if (input === SENHA_DO_SISTEMA) {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            initApp();
        } else {
            errorDiv.innerText = "Senha incorreta!";
            document.getElementById('passInput').value = "";
        }
    }

    document.getElementById('passInput').addEventListener("keypress", function(event) {
        if (event.key === "Enter") window.checkPassword();
    });

    window.lockApp = function() {
        document.getElementById('lockScreen').style.display = 'flex';
        document.getElementById('appContent').style.display = 'none';
        document.getElementById('passInput').value = "";
        document.getElementById('passError').innerText = "";
    }

    // --- VARI√ÅVEIS APP ---
    let currentDocId = "";
    let isReceiving = false;
    let saveTimer;
    let unsubscribe = null;
    let chartInstance = null;
    
    window.paidDebtors = [];
    window.iconsList = ["üí∏", "üè†", "üì∂", "üè∞", "üéß", "ü•ä", "üíÖ", "‚úçÔ∏è", "üöó", "üõí", "üíÑ", "üè•", "üèãÔ∏è", "üë±", "üßî"];

    function initApp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const defaultDate = `${year}-${month}`;
        
        const picker = document.getElementById('monthPicker');
        if (!picker.value) {
            picker.value = defaultDate;
            loadMonthData(defaultDate);
        }
    }

    window.changeMonth = function() {
        const picker = document.getElementById('monthPicker');
        if (currentDocId && !isReceiving) saveData(true); 
        if (picker.value) loadMonthData(picker.value);
    }

    window.copyPreviousMonth = async function() {
        if(!confirm("Importar dados do m√™s anterior?")) return;

        const parts = currentDocId.split('-');
        let year = parseInt(parts[0]);
        let month = parseInt(parts[1]);

        month--; 
        if (month === 0) { month = 12; year--; }

        const prevId = `${year}-${String(month).padStart(2, '0')}`;
        document.getElementById('syncStatus').innerText = "Buscando " + prevId + "...";

        try {
            const docSnap = await getDoc(doc(db, "gastos_namorada", prevId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                data.paidDebtors = []; 
                isReceiving = true; 
                updateScreen(data); 
                setTimeout(() => { 
                    isReceiving = false; 
                    saveData(true); 
                    alert("Dados importados!");
                }, 500);
            } else {
                alert("Sem dados em " + prevId);
            }
        } catch(e) { console.error(e); alert("Erro ao importar."); }
    }

    function loadMonthData(dateString) {
        currentDocId = dateString;
        document.getElementById('syncStatus').innerText = "Carregando...";
        if (unsubscribe) unsubscribe();
        
        const docRef = doc(db, "gastos_namorada", currentDocId);

        unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                isReceiving = true;
                const data = docSnap.data();
                window.paidDebtors = data.paidDebtors || [];
                updateScreen(data);
                setTimeout(() => isReceiving = false, 500);
                document.getElementById('syncStatus').innerHTML = '<span style="color:#db2777">‚òÅ Sincronizado</span>';
            } else {
                window.paidDebtors = [];
                updateScreen(null); 
                saveData(true);      
            }
        });
    }

    // AQUI EST√Å A CORRE√á√ÉO: Fun√ß√£o updateScreen "vacinada"
    function updateScreen(data) {
        if (!data) data = getDefaultData();
        
        // 1. Garante que o Cart√£o Inter esteja l√°
        if (data.main && !data.main.some(i => i.id === 'inter_auto')) {
             data.main.unshift({ icon: 'üí≥', name: 'Meu Inter', value: 0, isMine: true, locked: true, id: 'inter_auto' });
        }

        // 2. CORRE√á√ÉO: Garante que "Fatura Igor" e "Fatura Lucas" apare√ßam, mesmo em meses velhos
        if (data.main) {
            const hasIgor = data.main.some(i => i.name === 'Fatura Igor');
            if (!hasIgor) data.main.push({ icon: 'üë±', name: 'Fatura Igor', value: 0, isMine: true });

            const hasLucas = data.main.some(i => i.name === 'Fatura Lucas');
            if (!hasLucas) data.main.push({ icon: 'üßî', name: 'Fatura Lucas', value: 0, isMine: true });
        }

        document.getElementById('salary').value = data.salary || 0;
        document.getElementById('emergencyFund').value = data.emergency || 0;
        document.getElementById('interTotalBill').value = data.interTotal || 0;

        renderTable('mainTable', data.main || [], 'main');
        renderTable('interTable', data.inter || [], 'split');
        calculateAll();
    }

    function getDefaultData() {
        return {
            salary: 2271.27, 
            emergency: 0, interTotal: 0,
            main: [
                // ESTES S√ÉO OS DADOS PADR√ÉO PARA MESES NOVOS
                { icon: 'üí≥', name: 'Meu Inter', value: 0, isMine: true, locked: true, id: 'inter_auto' },
                { icon: 'üë±', name: 'Fatura Igor', value: 0, isMine: true },
                { icon: 'üßî', name: 'Fatura Lucas', value: 0, isMine: true },
                { icon: 'üì∂', name: 'Claro Flex', value: 40.00, isMine: true },
                { icon: 'üè∞', name: 'Disney', value: 11.71, isMine: true },
                { icon: 'üèãÔ∏è', name: 'Academia', value: 95.00, isMine: true },
                { icon: 'üéß', name: 'Spotify (Lucas)', value: 15.95, isMine: true },
                { icon: 'ü•ä', name: 'Muay Thai', value: 130.00, isMine: true },
                { icon: 'üíÖ', name: 'Unhas', value: 100.00, isMine: true },
                { icon: '‚úçÔ∏è', name: 'Concursos', value: 100.00, isMine: true },
                { icon: 'üõí', name: 'Supermercado', value: 100.00, isMine: true }
            ], inter: [], paidDebtors: []
        };
    }

    function renderTable(id, list, type) {
        const tbody = document.querySelector(`#${id} tbody`);
        tbody.innerHTML = "";
        list.forEach(item => { if (type === 'main') addMainRowHTML(tbody, item); else addSplitRowHTML(tbody, item); });
    }

    window.calculateAll = function() {
        const inter = processCard('interTable', 'interTotalBill', 'interMyShareDisplay', 'inter_auto');

        let totalExpenses = 0; let myRealExpenses = 0; let fixedSum = 0;
        const emergency = parseFloat(document.getElementById('emergencyFund').value) || 0;
        totalExpenses += emergency;

        document.querySelectorAll('#mainTable tbody tr').forEach(tr => {
            const val = parseFloat(tr.querySelector('.val-input').value) || 0;
            const isMine = tr.querySelector('input[type="checkbox"]').checked;
            const isCardAuto = tr.querySelector('.val-input').hasAttribute('readonly'); 
            
            totalExpenses += val;
            if (isMine) myRealExpenses += val;
            if (!isCardAuto) fixedSum += val; 
        });

        const salary = parseFloat(document.getElementById('salary').value) || 0;
        document.getElementById('totalExpenses').innerText = fmt(totalExpenses);
        document.getElementById('remaining').innerText = fmt(salary - totalExpenses);
        document.getElementById('myRealExpenses').innerText = fmt(myRealExpenses);

        updateDebtors({ ...inter.debtors }, {}, {}, {});
        
        const cardsTotal = inter.myShare;
        updateChart(fixedSum, cardsTotal, emergency, salary - totalExpenses);
    }

    function updateChart(fixed, cards, emerg, rest) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        if (rest < 0) rest = 0;

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Fixos/D√≠vidas', 'Cart√£o Inter', 'Reserva', 'Livre'],
                datasets: [{
                    data: [fixed, cards, emerg, rest],
                    backgroundColor: ['#db2777', '#f59e0b', '#9333ea', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function processCard(tableId, totalId, displayId, autoInputId) {
        const totalBill = parseFloat(document.getElementById(totalId).value) || 0;
        let othersSum = 0; let debtors = {};
        document.querySelectorAll(`#${tableId} tbody tr`).forEach(tr => {
            const name = tr.querySelector('.split-name').value.trim();
            const val = parseFloat(tr.querySelector('.split-val').value) || 0;
            const inst = tr.querySelector('.split-inst').value;
            if (val > 0) {
                othersSum += val;
                if (name) {
                    const key = name.toLowerCase();
                    if (!debtors[key]) debtors[key] = { name: name, total: 0, future: 0 };
                    debtors[key].total += val;
                    if (inst.includes('/')) { const [cur, tot] = inst.split('/').map(Number); if (tot > cur) debtors[key].future += (tot - cur) * val; }
                }
            }
        });
        const myShare = totalBill - othersSum;
        document.getElementById(displayId).innerText = fmt(myShare);
        const autoInput = document.getElementById(autoInputId);
        if (autoInput) autoInput.value = myShare.toFixed(2);
        return { debtors, myShare };
    }

    // BOILERPLATE
    window.addMainRow = () => { addMainRowHTML(document.querySelector("#mainTable tbody"), {icon:'üí∏',name:'',value:'',isMine:true}); calculateAndSchedule(); }
    window.addSplitRow = (id) => { addSplitRowHTML(document.querySelector(`#${id} tbody`), {name:'',desc:'',inst:'',value:''}); calculateAndSchedule(); }
    
    function addMainRowHTML(tbody, item) {
        const tr = document.createElement("tr");
        let opts = window.iconsList.map(i => `<option value="${i}" ${i === item.icon ? 'selected' : ''}>${i}</option>`).join('');
        const locked = item.locked ? 'readonly style="background:#fce7f3; color:#999"' : '';
        const del = item.locked ? '' : `<button class="btn-del" onclick="removeRow(this)">√ó</button>`;
        tr.innerHTML = `<td><select class="icon-select" onchange="calculateAndSchedule()">${opts}</select></td><td><input type="text" class="td-input" value="${item.name}" ${locked} oninput="calculateAndSchedule()"></td><td><input type="number" class="td-input val-input" value="${item.value}" step="0.01" id="${item.id || ''}" ${locked} oninput="calculateAndSchedule()"></td><td style="text-align:center"><input type="checkbox" ${item.isMine ? 'checked' : ''} onchange="calculateAndSchedule()"></td><td>${del}</td>`;
        tbody.appendChild(tr);
    }
    function addSplitRowHTML(tbody, item) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><input type="text" class="td-input split-name" value="${item.name}" placeholder="Nome" oninput="calculateAndSchedule()"></td><td><input type="text" class="td-input" value="${item.desc}" placeholder="Item" oninput="calculateAndSchedule()"></td><td><input type="text" class="td-input split-inst" value="${item.inst || ''}" placeholder="1/10" oninput="updateBar(this); calculateAndSchedule()"><div class="prog-bar"><div class="prog-fill" style="width:0%"></div></div></td><td><input type="number" class="td-input val-input split-val" value="${item.value}" step="0.01" oninput="calculateAndSchedule()"></td><td><button class="btn-del" onclick="removeRow(this)">√ó</button></td>`;
        tbody.appendChild(tr);
        if(item.inst) updateBar(tr.querySelector('.split-inst'));
    }
    window.removeRow = (btn) => { btn.closest('tr').remove(); calculateAndSchedule(); }
    window.updateBar = (input) => { const val = input.value; const bar = input.nextElementSibling.querySelector('.prog-fill'); if(val.includes('/')) { const [cur, tot] = val.split('/').map(Number); if(tot > 0) bar.style.width = Math.min((cur/tot)*100, 100) + '%'; } else bar.style.width = '0%'; }
    window.togglePaid = (name) => { const idx = window.paidDebtors.indexOf(name); if (idx > -1) window.paidDebtors.splice(idx, 1); else window.paidDebtors.push(name); calculateAndSchedule(); }
    
    function updateDebtors(d1, d2, d3, d4) {
        const list = document.getElementById('debtorsList'); list.innerHTML = "";
        const all = {}; const merge = (s) => { for (let k in s) { if (!all[k]) all[k] = {...s[k]}; else { all[k].total += s[k].total; all[k].future += s[k].future; } } };
        merge(d1); merge(d2); merge(d3); merge(d4);
        let tr = 0; let r = 0;
        if (Object.keys(all).length === 0) list.innerHTML = "<div style='color:#999; width:100%; text-align:center'>Ningu√©m deve nada.</div>";
        else {
            for (let k in all) {
                const p = all[k]; const isPaid = window.paidDebtors.includes(p.name);
                if (isPaid) r += p.total; else tr += p.total;
                const div = document.createElement('div'); div.className = `debt-item ${isPaid ? 'is-paid' : ''}`;
                div.innerHTML = `<div class="d-head"><div class="d-name">${p.name}</div><div class="pay-check ${isPaid ? 'checked' : ''}" onclick="togglePaid('${p.name}')">${isPaid ? '‚úî' : ''}</div></div><div class="d-status">${isPaid ? 'PAGO' : 'PENDENTE'}</div><div class="d-val">${fmt(p.total)}</div><div class="d-fut">${p.future > 0 ? `+ ${fmt(p.future)} fut.` : 'Quitado'}</div>`;
                list.appendChild(div);
            }
        }
        document.getElementById('totalToReceive').innerText = fmt(tr); document.getElementById('totalReceived').innerText = fmt(r);
    }
    
    function fmt(n) { return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    window.calculateAndSchedule = () => { calculateAll(); if (isReceiving) return; document.getElementById('syncStatus').innerText = "..."; clearTimeout(saveTimer); saveTimer = setTimeout(() => saveData(), 1000); }
    
    async function saveData(force = false) {
        if (isReceiving && !force) return;
        const data = { 
            salary: document.getElementById('salary').value, 
            emergency: document.getElementById('emergencyFund').value, 
            interTotal: document.getElementById('interTotalBill').value, 
            paidDebtors: window.paidDebtors, 
            main: [], inter: [] 
        };
        document.querySelectorAll('#mainTable tbody tr').forEach(tr => { data.main.push({ icon: tr.querySelector('.icon-select').value, name: tr.querySelector('input[type="text"]').value, value: tr.querySelector('.val-input').value, isMine: tr.querySelector('input[type="checkbox"]').checked, locked: tr.querySelector('.val-input').hasAttribute('readonly'), id: tr.querySelector('.val-input').id || null }); });
        const sc = (id, arr) => { document.querySelectorAll(`#${id} tbody tr`).forEach(tr => { const i = tr.querySelectorAll('input'); arr.push({ name: i[0].value, desc: i[1].value, inst: i[2].value, value: i[3].value }); }); };
        sc('interTable', data.inter);
        try { await setDoc(doc(db, "gastos_namorada", currentDocId), data); document.getElementById('syncStatus').innerHTML = '<span style="color:#db2777">‚òÅ Salvo</span>'; } catch (e) { console.error(e); document.getElementById('syncStatus').innerText = "Erro Save"; }
    }
</script>
</body>

</html>
